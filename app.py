
import streamlit as st
import openai
from llama_index import GPTVectorStoreIndex, SimpleDirectoryReader

# Streamlit Community Cloudã®ã€ŒSecretsã€ã‹ã‚‰OpenAI API keyã‚’å–å¾—
openai.api_key = st.secrets.OpenAIAPI.openai_api_key

# st.session_stateã‚’ä½¿ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¿å­˜
if "messages" not in st.session_state:
    st.session_state["messages"] = [
        {"role": "system", "content": """
{ãƒ†ãƒ¼ãƒ} = å®‰é”ã¨ã—ã¾ã‚€ã‚‰

ã‚ãªãŸã¯{ãƒ†ãƒ¼ãƒ}ã®å°‚é–€å®¶ã§ã™ã€‚{ãƒ†ãƒ¼ãƒ}ã®ç†è§£ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ãŸã‚ã®4æŠå•é¡Œã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚ ã¯ã˜ã‚ã«åˆç´šãƒ¬ãƒ™ãƒ«ã®å•é¡Œã‹ã‚‰å§‹ã‚ã€æ­£ã—ã„å›ç­”ãŒå¾—ã‚‰ã‚Œã‚‹ãŸã³ã«å•é¡Œã®é›£æ˜“åº¦ã‚’å¾ã€…ã«ä¸Šã’ã¦ãã ã•ã„ã€‚

ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦æ±‚
ãƒ»ã‚ãªãŸãŒå‡ºé¡Œ
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”
ãƒ»ã‚ãªãŸãŒæ­£è§£ã®ç™ºè¡¨
...
ä»¥ä¸‹åŒæ§˜ã«ç¹°ã‚Šè¿”ã™

ã¨ã„ã†æµã‚Œã§é€²ã¿ã¾ã™ã€‚ ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦æ±‚ã€ã¨ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ã€ã®éƒ¨åˆ†ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã™ã‚‹éƒ¨åˆ†ã§ã™ã€‚ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å¾…ã¡ã¾ã™ã€‚

***ä»¥ä¸‹ã®æ‰‹é †ã«å³å¯†ã«å¾“ã£ã¦ãã ã•ã„***

###æ‰‹é †
1. å…¥åŠ›
2. å‡ºåŠ›
3. å¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰
4. å…¥åŠ›'
5. å‡ºåŠ›'
6. æ‰‹é †1ã«æˆ»ã‚‹

ã€æ‰‹é †1ã€‘
!!! å¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ãŒã‚ã‚‹ã¾ã§å¾…æ©Ÿã—ã¾ã™ã€‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¦æ±‚ã®å…¥åŠ›ãŒã‚ã£ãŸã‚‰ã€ã€æ‰‹é †2ã€‘ã«é€²ã‚“ã§ãã ã•ã„ã€‚
<å…¥åŠ›>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š"ã‚¯ã‚¤ã‚ºå‡ºã—ã¦"

ã€æ‰‹é †2ã€‘
---å‡ºåŠ›æ§˜å¼---

{å•é¡Œæ–‡}
1. ï½›é¸æŠè‚¢1ï½
2. ï½›é¸æŠè‚¢2ï½
3. ï½›é¸æŠè‚¢3ï½
4. ï½›é¸æŠè‚¢4ï½


---å‡ºåŠ›æ§˜å¼ä»¥ä¸Š---
â€»å•é¡Œã¯1å•ã ã‘å‡ºã—ã¦ãã ã•ã„ã€‚
1å•å‡ºã—ãŸã‚‰ã€æ‰‹é †3ã€‘ã«é€²ã‚“ã§ãã ã•ã„ã€‚

ã€æ‰‹é †3ã€‘
!!! å¾…æ©Ÿãƒ¢ãƒ¼ãƒ‰: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å›ç­”ãŒã‚ã‚‹ã¾ã§å¾…æ©Ÿã—ã¾ã™ã€‚ ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç­”ãˆã‚’çµ¶å¯¾ã«å‡ºåŠ›ã—ãªã„ã§ãã ã•ã„ã€‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰å›ç­”ã®å…¥åŠ›ãŒã‚ã£ãŸã‚‰ã€ã€æ‰‹é †4ã€‘ã«é€²ã‚“ã§ãã ã•ã„

ã€æ‰‹é †4ã€‘
<å…¥åŠ›>ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š{å›ç­”}
â€»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å›ç­”ãŒã‚ã£ãŸã‚‰ã€æ‰‹é †4ã€‘ã«é€²ã‚“ã§ãã ã•ã„

ã€æ‰‹é †5ã€‘
---å‡ºåŠ›æ§˜å¼---
{æ­£ã—ã„å›ç­”}{æ­£ã—ã„å›ç­”ã®è§£èª¬}

{å•é¡Œæ–‡}
1. ï½›é¸æŠè‚¢1ï½
2. ï½›é¸æŠè‚¢2ï½
3. ï½›é¸æŠè‚¢3ï½
4. ï½›é¸æŠè‚¢4ï½


---å‡ºåŠ›æ§˜å¼ä»¥ä¸Š---

ã€æ‰‹é †6ã€‘
 ã€æ‰‹é †1ã€‘ã«æˆ»ã£ã¦ãã ã•ã„
"""
        }
        ]

# ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹é–¢æ•°
def communicate():
    messages = st.session_state["messages"]

    user_message = {"role": "user", "content": st.session_state["user_input"]}
    messages.append(user_message)

    documents = SimpleDirectoryReader("data").load_data()
    index = GPTVectorStoreIndex.from_documents(documents)
    query_engine = index.as_query_engine()
    response = query_engine.query(user_message)

    bot_message = response["choices"][0]["message"]
    messages.append(bot_message)

    st.session_state["user_input"] = ""  # å…¥åŠ›æ¬„ã‚’æ¶ˆå»


# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®æ§‹ç¯‰
st.title("My AI Assistant")
st.write("ChatGPT APIã‚’ä½¿ã£ãŸãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚")

user_input = st.text_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", key="user_input", on_change=communicate)

if st.session_state["messages"]:
    messages = st.session_state["messages"]

    for message in reversed(messages[1:]):  # ç›´è¿‘ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸Šã«
        speaker = "ğŸ™‚"
        if message["role"]=="assistant":
            speaker="ğŸ¤–"

        st.write(speaker + ": " + message["content"])
